name: Auto Grass

on:
  schedule:
    # UTCで解釈。JST 9:00 = UTC 0:00
    - cron: "0 0 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  grow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # pull/rebase するため履歴を全取得
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Run daily script
        run: npm start

      - name: Commit & Push if changed
        run: |
          # 変更がある？
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "auto-grass-bot"
            git config user.email "actions@users.noreply.github.com"

            # 最新を取得
            git fetch origin main

            # 生成物を含め "全部" 一時退避（インデックスも含む）
            git stash push --include-untracked -m "auto-grass tmp" || true

            # リモート先行分を取り込み
            git pull --rebase origin main

            # 退避した変更を戻す
            git stash pop || true

            # daily_log.md だけをコミット対象に
            git add daily_log.md
            git commit -m "chore(grass): update daily_log [skip ci]" || echo "No changes"
            git push
          else
            echo "No changes to commit."
          fi
